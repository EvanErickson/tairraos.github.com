(function(){var c=document.getElementById("basket"),m=document.getElementById("title"),o=document.getElementById("readme"),p=document.getElementById("report"),i={totalPay:0,dayData:{},monthNum:{},monthPay:{},yearPay:{}};window.conf=i;if(!window.FileReader){c.innerHTML="你的浏览器太老了，换一个浏览器试试。";return}c.addEventListener("dragenter",d,false);c.addEventListener("dragover",d,false);c.addEventListener("dragleave",h,false);c.addEventListener("drop",a,false);document.title+=" by 小乐";m.innerHTML=document.title;o.innerHTML="把“导出获得的xls或xlsx文件”拖放到此处。";function h(){c.classList.remove("dragover")}function d(q){c.classList.add("dragover");q.stopPropagation();q.preventDefault()}function a(q){file=q.dataTransfer.files;q.stopPropagation();q.preventDefault();if(!file.length){c.innerHTML="文件拖放动作有问题，重试一次。";h();return}k(file[0])}function k(r){if(r.name.match(/\.xls.?$/)){var q=new FileReader();q.onload=function(u){var t=u.target.result;var s=XLSX.read(t,{type:"binary"});if(!s.Sheets["待收明细报表_全部"]){c.innerHTML="你拖放的xls不是微贷散标导出文件，重试一次。";return}l(s.Sheets["待收明细报表_全部"]);c.style.display="none"};q.readAsBinaryString(r)}else{c.innerHTML="你拖放的不是xls文件，重试一次。"}h()}function e(q){return Math.round(+q*100)/100}function n(q){return q.replace("-","年")+"月"}function l(F){var s=5,A=+F["!ref"].match(/(\d+)/)[1],G=i.dayData,u=i.monthPay,z=i.monthNum,r=i.yearPay;for(var q=s;q<=A;q++){var C=F["A"+q].v.match(/抵|械/),B=F["B"+q].v.slice(-10),w=B.slice(0,-3),D=w.slice(0,-3),E=F["D"+q].v,t=G[B]||{pay:0,credit:0,num:0,bnum:0,bpay:0};G[B]=t;t.pay=e(t.pay+E);t.credit=t.credit+(+!C);t.num=t.num+1;t.bnum=t.bnum+ +(E>100);t.bpay=t.bpay>E?t.bpay:E;u[w]=e((u[w]||0)+E);z[w]=e((z[w]||0)+1);r[D]=e((r[D]||0)+E);i.totalPay=e(i.totalPay+E)}i.lastPayDay=F["B"+A].v.slice(-10);f();b()}function f(){var u=echarts.init(document.getElementById("chart"),"light"),q,y,v=[],w=[],s=0;for(q in i.yearPay){v.push({value:i.yearPay[q],name:q+"年 "+e(i.yearPay[q]/i.totalPay*100)+"%"})}y=0;for(q in i.monthPay){s=e(s+i.monthPay[q]);w.push({value:Math.floor(s/i.totalPay*100)+"%",name:"进度: "+e(s/i.totalPay*100)+"%",xAxis:y++,yAxis:i.monthPay[q]})}var t={title:{},tooltip:{},legend:{},xAxis:{splitNumber:Object.keys(i.monthPay).length,axisLabel:{interval:0},data:Object.keys(i.monthPay).map(function(z){return{value:z.match(/-01/)?z.slice(0,-3)+"年":z.slice(-2)+"月",textStyle:{fontSize:10}}})},yAxis:{},series:[{name:"月回款",type:"line",lineStyle:{color:"#600"},smooth:true,data:Object.values(i.monthPay)},{name:"月回款",type:"bar",markPoint:{symbol:"pin",data:w,symbolSize:[1,30],label:{color:"#333",fontSize:10},itemStyle:{color:"#fff",}},label:{show:true,position:"insideBottom",rotate:45,offset:[2,-8],fontSize:8},data:Object.values(i.monthPay)},{name:"年回款",type:"pie",radius:"40%",center:["70%","35%"],data:v}]};u.setOption(t);var r=["回款分析："];r.push("");r.push("待还总本金金额："+i.totalPay+"元");r.push("共有待执行合同："+Math.max.apply(Math,Object.values(i.monthNum))+"个");r.push("最后一笔回款时间："+i.lastPayDay.replace(/-(\d\d)-(\d\d)/,"年$1月$2日"));r.push("");for(q in i.yearPay){r.push(q+"年还款："+i.yearPay[q]+"元，占比"+e(i.yearPay[q]/i.totalPay*100)+"%")}r.push("");s=0;for(q in i.monthPay){s=e(s+i.monthPay[q]);r.push(n(q)+"还款："+i.monthPay[q]+"元("+e(i.monthPay[q]/i.totalPay*100)+"%)；"+"累计还款："+s+"元("+e(s/i.totalPay*100)+"%)；"+"执行合同数:"+i.monthNum[q]+"个")}r.push("");p.innerHTML=r.join("<br>\n")}function j(q){var r=new Date(+(new Date(q))+1000*60*60*24);return r.getFullYear()+("0"+(r.getMonth()+1)).slice(-2)+("0"+r.getDate()).slice(-2)}function g(q){return q.replace(/-/g,"")}function b(){var q=document.createElement("a"),r=[];r.push("BEGIN:VCALENDAR");r.push("METHOD:PUBLISH");r.push("VERSION:2.0");r.push("X-WR-CALNAME:微贷");r.push("X-APPLE-CALENDAR-COLOR:#660000");r.push("X-WR-TIMEZONE:Asia/Shanghai");r.push("CALSCALE:GREGORIAN");for(x in i.dayData){r.push("BEGIN:VEVENT");var s=i.dayData[x];r.push("SUMMARY:还款"+s.pay+"元");r.push("DESCRIPTION:"+["今日还款"+s.pay+"元","执行合同"+s.num+"个","信用标"+s.credit+"个","抵押标"+(s.num-s.credit)+"个","大于100元的标"+s.bnum+"个","最大还款标"+s.bpay+"元"].join("\\n"));r.push("DTSTART;VALUE=DATE:"+g(x));r.push("DTEND;VALUE=DATE:"+j(x));r.push("SEQUENCE:1");r.push("END:VEVENT")}r.push("END:VCALENDAR");q.innerHTML="导出还款日历";q.download="微贷.ics";q.href=URL.createObjectURL(new Blob([r.join("\n")]));p.appendChild(q)}}());